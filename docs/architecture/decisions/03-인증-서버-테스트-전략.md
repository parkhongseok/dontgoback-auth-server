# 인증 서버 테스트 전략

Date: 2025-08-03  
Status: Accepted

<br/>

## 맥락

JWT 기반 인증 토큰 발급과 공개키 제공 기능을 담당하는 이 마이크로서비스는,  
MSA 환경에서 **서버 간 보안 통신의 중심 역할**을 수행합니다.

이 과정에서 클라이언트 인증 실패, 키 미초기화 등 다양한 예외 상황에 대한 철저한 검증이 요구되며,  
따라서 신뢰 가능한 테스트 전략을 수립하는 것이 필수적이었습니다.

특히 `Spring Security` 기반 구조 특성상, 테스트 환경에서는 인증 필터로 인한 요청 차단 이슈를 고려해야 했고,  
MockMvc와 보안 설정을 적절히 조정하는 과정이 필요했습니다.

<br/>
<br/>

## 결정

다음과 같은 테스트 전략을 수립하였습니다:

### 1. 컨트롤러 단위 테스트 전략

- `@WebMvcTest`를 활용하여 컨트롤러 단위 테스트만 수행하도록 구성
- `@MockitoBean` (Spring 3.4 이상) 을 활용하여 내부 의존성을 목(mock)으로 대체
- `MockMvc`를 활용한 REST 요청 및 응답 시뮬레이션
- `application-test.yml`과 `@ActiveProfiles("test")` 조합으로 테스트 환경 분리
- `@AutoConfigureMockMvc(addFilters = false)`를 통해 Spring Security 필터 제거

### 2. 테스트 대상 컨트롤러 및 항목

| 컨트롤러                   | 테스트 대상 | 시나리오                      | 기대 결과                 |
| -------------------------- | ----------- | ----------------------------- | ------------------------- |
| `ApiV1TokenController`     | 토큰 발급   | 등록된 클라이언트 ID & 시크릿 | 200 OK + JWT 응답         |
|                            |             | 올바른 ID, 틀린 시크릿        | 401 Unauthorized          |
|                            |             | 등록되지 않은 ID              | 401 Unauthorized          |
| `ApiV1PublicKeyController` | 공개키 응답 | 공개키 정상 초기화 상태       | 200 OK + Base64 응답      |
|                            |             | 공개키 초기화 실패 시         | 500 Internal Server Error |

### 3. 기타 고려 사항

- 실제 공개키/개인키는 테스트 환경에서는 사용하지 않고 목(mock)으로 대체할 수 있음
- 테스트 전용 시크릿은 `application-test.yml`을 통해 분리 관리
- 유효성 검사, 응답 JSON 구조까지 검증하도록 `jsonPath` 활용

<br/>
<br/>

## 결과

- 기능별 예외 및 성공 케이스를 명확히 검증할 수 있었고, 보안 설정이 테스트에 영향을 주지 않도록 분리
- 서버 간 통신에서 발생 가능한 오류 상황을 빠르게 확인 가능
- 추후 기능 추가 시에도 동일한 테스트 전략을 확장 가능

---

> 참고: 실제 테스트 코드는 `src/test/java/...` 패키지에 위치하며, MockMvc 기반으로 작성되어 있음
