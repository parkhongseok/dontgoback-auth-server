# 인증 서버 통합 테스트 전략

Date: 2025-08-05

Status: Accepted (Supersedes 03-인증-서버-테스트-전략 판)

<br/>

## 맥락

2025‑08‑03 버전에서는 컨트롤러 단위 테스트만 다루었으나, 이후

* 전체 애플리케이션 레이어를 아우르는 **통합 테스트**(`@SpringBootTest`)가 추가되었으며,
* 단위 테스트에서 반복되는 코드를 줄이고,
* 모든 단위‑테스트 클래스가 파라미터라이즈드 테스트와 통일된 Naming / Display 스타일을 사용하도록 리팩터링되었습니다.

이에 따라 테스트 전략 ADR을 갱신합니다.

<br/>
<br/>

## 결정

### 1. 테스트 분류 및 목적

| 구분              | 어노테이션                                                      | 범위          | 주된 목적                            | 대표 클래스                                                     |
| --------------- | ---------------------------------------------------------- | ----------- | -------------------------------- | ---------------------------------------------------------- |
| **컨트롤러 단위 테스트** | `@WebMvcTest` + `@AutoConfigureMockMvc(addFilters =false)` | MVC 슬라이스    | *요청–응답·예외* 로직만 검증                | `ApiV1TokenControllerTest`, `ApiV1PublicKeyControllerTest` |
| **통합 테스트**      | `@SpringBootTest`                                          | 전체 스프링 컨텍스트 | 키 로딩, JWT 발급·검증 등 **실제 빈 연동** 확인 | `AuthServerTest`                                           |

<br/>
<br/>

### 2. 공통 테스트 스타일 가이드

1. **Display Name** 규칙 — 한국어 문장으로 "무엇을/왜" 설명.

   ```java
   @DisplayName("JWT 검증 후 issuer·subject 가 예상값과 일치한다")
   ```
2. **케이스 헤더 주석** — `/* ---------- 성공 케이스 ---------- */` 와 같이 섹션 구분.
3. **파라미터라이즈드 테스트** — `@ParameterizedTest(name = "[{index}] {0} → 401 Unauthorized")` 사용, 데이터는 `@MethodSource`.
4. **의존성 대체 규칙**

   * 컨트롤러 테스트: `@MockBean` / `@MockitoBean` 으로 외부 빈 목 처리.
   * 통합 테스트: 실제 빈 사용, 단 외부 시스템 호출은 Test Double 적용.
5. **보안 필터 분리** — 단위 테스트에서만 `addFilters =false` 로 Security Filter Chain 제거.
6. **테스트 전용 프로퍼티** — `application-test.yml`에 클라이언트 목록·키 경로 분리.

<br/>
<br/>

### 3. 테스트 시나리오 갱신

| 컨트롤러                         | 시나리오             | 예상 결과                     | 비고                |
| ---------------------------- | ---------------- | ------------------------- | ----------------- |
| **ApiV1TokenController**     | ✅ 정상 ID + Secret | 200 OK + JWT              | 파라미터라이즈드 "성공" 케이스 |
|                              | ❌ Secret 오류      | 401 Unauthorized          | "실패" 케이스          |
|                              | ❌ 미등록 ID         | 401 Unauthorized          | "실패" 케이스          |
| **ApiV1PublicKeyController** | ✅ 키 초기화 완료       | 200 OK + Base64           | 성공 케이스            |
|                              | ❌ 키 null         | 500 Internal Server Error | 실패 케이스            |
| **AuthServerTest**(통합)       | 공개키 로딩           | `PublicKey` not null      | 전체 컨텍스트           |
|                              | JWT 발급           | 토큰 not null               | 〃                 |
|                              | JWT 검증           | issuer·subject 일치         | 〃                 |

<br/>
<br/>

### 4. 구현 세부 사항

* **키 생성**: 단위 테스트는 `KeyPairGenerator`로 임시 RSA 키 생성, Base64 인코딩 후 응답 비교.
* **토큰 발급**: 통합 테스트는 실제 `TokenProvider`로 토큰 생성, `TestTokenVerifier`로 검증.
* **MockMvc**: 공통 `perform()` 유틸 메서드로 요청 · 검증 중복 제거.

<br/>
<br/>

## 결과

* 컨트롤러·통합 레이어를 모두 커버하여 **회귀 버그**를 조기에 탐지.
* 테스트 코드 구조가 통일되어 **가독성** 및 **유지보수성** 향상.
* MSA 환경에서 **키 미초기화, 토큰 위·변조** 등 보안 이슈를 사전에 차단.

> **다음 단계** — 서버 간 gRPC 통신 모듈이 도입되면 동일 가이드에 따라 E2E 테스트를 추가할 예정입니다.